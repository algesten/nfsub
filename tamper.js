// ==UserScript==
// @name         Netflix Subtitles
// @namespace    http://www.netflix.com
// @version      1.0.0
// @description  subtitles on netflix
// @author       Martin Algesten
// @match        http://*/*
// @grant        none
// ==/UserScript==

!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var n;"undefined"!=typeof window?n=window:"undefined"!=typeof global?n=global:"undefined"!=typeof self&&(n=self),n.nfsub=e()}}(function(){return function e(n,t,r){function i(u,l){if(!t[u]){if(!n[u]){var a="function"==typeof require&&require;if(!l&&a)return a(u,!0);if(o)return o(u,!0);throw new Error("Cannot find module '"+u+"'")}var s=t[u]={exports:{}};n[u][0].call(s.exports,function(e){var t=n[u][1][e];return i(t?t:e)},s,s.exports,e,n,t,r)}return t[u].exports}for(var o="function"==typeof require&&require,u=0;u<r.length;u++)i(r[u]);return i}({1:[function(e,n,t){(function(){var t,r,i,o,u,l,a,s,f,d,c,v,m,p,g,y,h,x,b,T,w,E,L,N=[].slice;w=e("subplay"),d=function(e){return document.createElement(e)},o=function(e){var n;return null!=(n=document.getElementsByTagName(e))?n[0]:void 0},i=function(e){var n;return null!=(n=document.getElementsByClassName(e))?n[0]:void 0},f=function(){var e,n,t,r,i,o,u;for(o=arguments[0],i=2<=arguments.length?N.call(arguments,1):[],e=0,t=i.length;t>e;e++){r=i[e];for(n in r)u=r[n],void 0!==u&&(o[n]=u)}return o},y=function(e){return/in/.test(document.readyState)?setTimeout(y,9,e):e()},s=function(){var e;return e=1<=arguments.length?N.call(arguments,0):[],console.log.apply(console,e)},u=function(){return o("video")},r=function(){var e,n;return(e=i("nfsub"))?e:(n=i("player-timedtext"),e=d("div"),e.className="nfsub",n.parentNode.appendChild(e),e.innerHTML='<div class="nfsub-text"></div>\n<div class="nfsub-offs"></div>\n<div class="nfsub-load">Click to load subtitles<div>',f(e.style,{position:"absolute",bottom:"50px",left:"0",height:"100px",width:"100%",fontSize:"3vw",color:"#fff",textShadow:"-1px -1px 0 #000, 1px -1px 0 #000, -1px  1px 0 #000, 1px  1px 0 #000"}),f(i("nfsub-load").style,{textAlign:"center"}),f(i("nfsub-text").style,{textAlign:"center"}),f(i("nfsub-offs").style,{right:"0",top:"0",position:"absolute",display:"none"}),document.body.addEventListener("keydown",m),i("nfsub-load").addEventListener("click",p),s("attachDom appended",e),e)},p=function(e){var n;return s("onLoadClick",e),e.preventDefault(),e.stopPropagation(),n=d("input"),n.type="file",n.addEventListener("change",h,!1),n.opacity=0,document.body.appendChild(n),n.click()},a=function(e){return e.ctrlKey||e.metaKey||e.shiftKey},v=0,t=50,m=function(e){return a(e)?void 0:71===e.keyCode?(v-=t,T()):72===e.keyCode?(v+=t,T()):void 0},T=function(){var e;return e=i("nfsub-offs"),e.innerHTML=v+"ms",e.style.display="block",e._timeout&&clearTimeout(e._timeout),e._timeout=setTimeout(function(){return e.style.display="none"},1e3)},h=function(e){var n,t,r;return s("readFile",e),(n=null!=(r=e.target.files)?r[0]:void 0)?(t=new FileReader,t.onload=function(n){var t;return s("readFile onload",n),e.target.parentNode.removeChild(e.target),t=n.target.result,c.start(t),i("nfsub-load").style.display="none"},t.readAsText(n,"cp1252")):void 0},l=function(){var e,n,t;return s("start install event listener"),t=null,t&&t.removeEventListener("timeupdate",g),n=function(){return s("installing handler"),clearInterval(e),t.removeEventListener("timeupdate",n),t.addEventListener("timeupdate",g),r()},e=setInterval(function(){return t=u(),t?t.addEventListener("timeupdate",n):void 0},1e3)},s("waiting onready"),y(l),E=null,L=function(){},g=function(e){return L(e.target.currentTime)},x=function(e){return i("nfsub-text").innerHTML=e},b=function(e,n){var t;return t=attach(),t.innerHTML=n},n.exports=c={start:function(e){return E=w(e,x),L=function(e){var n;return E((n=e+v/1e3)>=0?n:0)}},stop:function(){return E(-1),E=null,L=function(){}}}}).call(this)},{subplay:2}],2:[function(e,n,t){(function(){n.exports=e("./sub")}).call(this)},{"./sub":3}],3:[function(e,n,t){(function(){var t,r,i,o,u,l,a,s,f,d=[].slice;s=e("subtitles-parser"),i=function(){var e;return null!=(e=document.getElementsByTagName("video"))?e[0]:void 0},a=function(){var e,n,t,r,i,o,u;for(o=arguments[0],i=2<=arguments.length?d.call(arguments,1):[],e=0,t=i.length;t>e;e++){r=i[e];for(n in r)u=r[n],void 0!==u&&(o[n]=u)}return o},u=function(e){return"string"==typeof e},o=function(e){return"function"==typeof e},t={millis:!1},r=function(e,n){return null==(null!=n?n.endTime:void 0)||e>(null!=n?n.endTime:void 0)?void 0:n.endTime-e},l=function(e,n,t,i){var o,u,a,s,f,d;return null==i&&(i=!0),o=e[t],u=r(n,o),i&&null!=u&&(f=e[t-1],d=r(n,f),null!=d&&u>d)?l(e,n,0,!1):(a=e[t+1],s=r(n,a),null==u||u>s?l(e,n,t+1,!1):t)},f=function(e,n,r){var i,f,d,c,v;if(null==r&&(r={}),!u(e))throw new Error("Bad srt");if(!o(n))throw new Error("Bad renderer");return r=a({},t,r),f=s.fromSrt(e,!0),d=0,i=null,c=null,v=function(e,t){var o,u,a,s;if(null==t&&(t=r.millis),u=t?e:1e3*e,d=l(f,u,d),o=f[d],s=Date.now(),a=function(e,t,r){return c=setTimeout(function(){return null!==i&&null!==r&&n(""),n(t),i=r,v(u+(Date.now()-s)+5,!0)},e)},c&&clearTimeout(c),0>u);else if(u<o.startTime){if(o!==i)return i&&a(0,"",null),a(o.startTime-u,o.text,o)}else if(u<o.endTime)return i===o?a(o.endTime-u,"",null):a(0,o.text,o)}},n.exports=f}).call(this)},{"subtitles-parser":4}],4:[function(e,n,t){var r=function(){var e={};e.fromSrt=function(e,t){var r=t?!0:!1;e=e.replace(/\r/g,"");var i=/(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/g;e=e.split(i),e.shift();for(var o=[],u=0;u<e.length;u+=4)o.push({id:e[u].trim(),startTime:r?n(e[u+1].trim()):e[u+1].trim(),endTime:r?n(e[u+2].trim()):e[u+2].trim(),text:e[u+3].trim()});return o},e.toSrt=function(e){if(!e instanceof Array)return"";for(var n="",r=0;r<e.length;r++){var i=e[r];isNaN(i.startTime)||isNaN(i.endTime)||(i.startTime=t(parseInt(i.startTime,10)),i.endTime=t(parseInt(i.endTime,10))),n+=i.id+"\r\n",n+=i.startTime+" --> "+i.endTime+"\r\n",n+=i.text.replace("\n","\r\n")+"\r\n\r\n"}return n};var n=function(e){var n=/(\d+):(\d{2}):(\d{2}),(\d{3})/,t=n.exec(e);if(null===t)return 0;for(var r=1;5>r;r++)t[r]=parseInt(t[r],10),isNaN(t[r])&&(t[r]=0);return 36e5*t[1]+6e4*t[2]+1e3*t[3]+t[4]},t=function(e){var n=[36e5,6e4,1e3],t=[];for(var r in n){var i=(e/n[r]>>0).toString();i.length<2&&(i="0"+i),e%=n[r],t.push(i)}var o=e.toString();if(o.length<3)for(r=0;r<=3-o.length;r++)o="0"+o;return t.join(":")+","+o};return e}();"object"==typeof t&&(n.exports=r)},{}]},{},[1])(1)});